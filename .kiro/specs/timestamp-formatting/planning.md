# 仕様検討記録

## 基本情報
- **作成日**: 2025-12-21
- **機能名**: timestamp-formatting

## 初期要求

Timestamp型を出力するときにhuman readableでないのが気になります。LocalとTimeZoneを見て適切な日時フォーマットにしたいと思いますが、どうでしょうか

## 質疑応答

### Q1. 対象範囲について

**質問**:
- 1-1. メタデータのみ対象ですか、それともドキュメントフィールド内のTimestamp型も対象ですか？
- 1-2. 現状、フィールド内のTimestampが実際に `{ "_seconds": ... }` 形式で出力されている問題を確認されていますか？

**回答**:
- 1-1: ドキュメントフィールド内のTimestampも含む
- 1-2: はい

### Q2. 日時フォーマットについて

**質問**:
- 2-1. 「LocalとTimeZone」とは、システムのロケールとタイムゾーン設定を自動検出して使用する想定ですか？
- 2-2. 希望するフォーマット例はありますか？
- 2-3. `--locale` や `--timezone` のようなCLIオプションでの上書きは必要ですか？

**回答**:
- 2-1: はい
- 2-2: 推奨フォーマットを提案 → ISO 8601 + タイムゾーン形式（選択肢A）を採用
- 2-3: 環境変数、コマンドラインオプション、設定ファイルで指定可能（優先順位は従来通り）

### Q3. 出力形式による動作の違いについて

**質問**:
- 3-1. --raw オプションでこの機能をオフにできるようにするのはどう思いますか？

**回答**:
- 3-1: 色付けオフと日付オフは独立させたい。煩雑なオプションは避けたい

### Q4. 設定について

**質問**:
- 4-1. 日時フォーマットの設定は `firex config` で永続化する必要がありますか？

**回答**:
- 4-1: 2-3のとおり（環境変数・CLIオプション・設定ファイルで対応）

### Q5. エラーハンドリングについて

**質問**:
- 5-1. 無効なタイムゾーン指定時の動作は？（エラー終了 or 警告してUTC使用）

**回答**:
- 5-1: 警告してUTCで

### Q6. ライブラリ選定について

**質問**:
- 6-1. date-fns + date-fns-tz で進めてよいですか？

**回答**:
- 6-1: はい。ただし直接呼び出さず後でライブラリを差し替えられるようにwrapなり抽象化なりしておいて

### Q7. オプション設計について

**質問**:
- 7-1. `--raw-output` / `-r` + 個別オプション方式でよいですか？
- 7-2. 現在 `--no-color` 相当のオプションは存在しますか？

**回答**:
- 7-1: `-r` は recursive に使いたいので短縮はなしで。他は提案通りで
- 7-2: 無いと思う

## 調査・検討結果

### 現状の問題
- メタデータ（createTime, updateTime, readTime）: `.toDate()` 変換済み → `.toISOString()` でUTC出力
- ドキュメントフィールド内のTimestamp: **変換処理なし** → `{ "_seconds": ..., "_nanoseconds": ... }` のような内部表現で出力

### フォーマット方式の選択肢
- 選択肢A: ISO 8601 + タイムゾーン（推奨・採用）: `2024-01-15T14:30:00+09:00`
- 選択肢B: ローカライズ形式: `2024/01/15 14:30:00 JST`
- 選択肢C: ISO 8601 + 簡略形式オプション

### ライブラリ候補
| ライブラリ | 採用理由 |
|-----------|---------|
| **date-fns + date-fns-tz** | Tree-shakable、Unicode CLDR準拠、TypeScript対応 |
| Luxon | 不採用（サイズ大きい） |
| Day.js | 不採用（独自フォーマット） |

### オプション設計
- `--raw-output`: すべての整形を無効化（短縮なし、`-r`は将来のrecursive用に予約）
- `--no-color`: 色付けのみ無効化
- `--no-date-format`: 日付整形のみ無効化
- `--timezone <tz>`: タイムゾーン指定
- `--date-format <fmt>`: フォーマット指定

## 決定事項

1. **対象**: メタデータ + ドキュメントフィールド内のTimestamp型
2. **デフォルトフォーマット**: `yyyy-MM-dd'T'HH:mm:ssXXX`（ISO 8601 + タイムゾーン）
3. **フォーマット指定方式**: Unicode CLDR形式
4. **ライブラリ**: date-fns v4 + @date-fns/tz（抽象化レイヤーで差し替え可能に）
5. **設定優先順位**: CLIオプション > 環境変数 > 設定ファイル > システム設定
6. **エラー時動作**: 警告を出力しUTCにフォールバック
7. **オプション体系**: `--raw-output` + 個別オプション（`--no-color`, `--no-date-format`）

## 備考

- `-r` 短縮形は将来の `--recursive` オプション用に予約
- NO_COLOR環境変数（値は問わない）もサポート（標準規格への準拠）
- date-fns v4ではTZDateクラスが導入され、date-fns-tzより軽量かつ公式サポート
