## Tasks

- [x] 1. (P) 診断結果の共通データ型とインターフェースを定義する
  - チェック結果のステータス（成功/警告/エラー）とカテゴリを表現する型を作成する
  - 診断レポート全体を表す構造（環境情報、チェック結果配列、サマリー）を定義する
  - 各チェッカー用のエラー型を定義し、neverthrow の Result パターンに統合する
  - _Requirements: 5.1, 5.2_

- [x] 2. 環境基本要件チェック機能を実装する

- [x] 2.1 (P) Node.js バージョン検出・検証機能を実装する
  - 実行中の Node.js バージョンを検出し、最小要件（18.0.0）を満たすか検証する
  - バージョンが要件を満たさない場合、エラーステータスとアップグレード手順を返す
  - _Requirements: 1.1_

- [x] 2.2 (P) Firebase CLI 検出機能を実装する
  - システムに Firebase CLI がインストールされているか確認し、バージョンを取得する
  - 未インストールの場合、警告ステータスと `npm install -g firebase-tools` の手順を返す
  - _Requirements: 1.2, 1.3_

- [x] 2.3 (P) Firebase 認証状態確認機能を実装する
  - gcloud ADC またはサービスアカウントによる認証が有効か確認する
  - 認証情報が見つからない場合、認証方法の選択肢と設定手順を含むガイダンスを返す
  - _Requirements: 1.4, 1.5_

- [x] 3. Firebase プロジェクト設定チェック機能を実装する

- [x] 3.1 .firebaserc ファイル検出・解析機能を実装する
  - カレントディレクトリから親ディレクトリを遡って .firebaserc を探索する
  - ファイルが存在する場合、デフォルトプロジェクト ID を抽出して表示する
  - ファイルが存在しない場合、Firebase プロジェクト初期化が必要である旨を警告する
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 3.2 Firestore API 有効化状態確認機能を実装する
  - プロジェクト ID が特定できた場合、Firestore API が有効化されているか確認する
  - 有効化されていない場合、Google Cloud Console での API 有効化手順を表示する
  - 3.1 で取得したプロジェクト ID に依存するため、3.1 完了後に実行
  - _Requirements: 2.4, 2.5_

- [x] 3.3 Firestore アクセス権限テスト機能を実装する
  - 認証情報が有効な場合、Firestore データベースへの読み取り操作を試行する
  - 権限エラーが発生した場合、必要な IAM ロールと設定方法を表示する
  - 認証状態チェック（2.3）と Firestore API チェック（3.2）の結果に依存
  - _Requirements: 2.6, 2.7_

- [x] 4. firex 設定ファイルバリデーション機能を実装する

- [x] 4.1 (P) 設定ファイル存在確認・構文検証機能を実装する
  - .firex.yaml または .firex.json の存在を確認する
  - ファイルが存在する場合、YAML/JSON としての構文が有効か検証する
  - 構文エラーがある場合、エラーの行番号・列番号と内容を具体的に表示する
  - ファイルが存在しない場合、デフォルト設定で動作する旨を情報として表示する
  - _Requirements: 3.1, 3.2, 3.3, 3.7_

- [x] 4.2 設定ファイルスキーマバリデーション機能を実装する
  - 構文が有効な設定ファイルに対し、zod スキーマによるバリデーションを実行する
  - スキーマ違反がある場合、違反している項目と期待される値の形式を表示する
  - 4.1 で構文検証が成功した場合のみ実行
  - _Requirements: 3.4, 3.5_

- [x] 4.3 コレクションパス形式検証機能を実装する
  - 設定ファイルにコレクションパスが含まれる場合、パスの形式が有効か検証する
  - Firestore のパス規則（奇数セグメント = コレクション）に従っているか確認する
  - _Requirements: 3.6_

- [x] 5. (P) ビルド状態チェック機能を実装する
  - dist/ ディレクトリの存在とビルドファイルの有無を確認する
  - ソースファイル（src/）とビルドファイル（dist/）のタイムスタンプを比較する
  - ソースが新しい場合、リビルドが必要である旨を警告する
  - npm パッケージとしてインストールされている場合（node_modules 内）はチェックをスキップする
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 6. エミュレータ環境対応機能を実装する

- [x] 6.1 (P) エミュレータモード検出機能を実装する
  - FIRESTORE_EMULATOR_HOST 環境変数の有無でエミュレータモードを検出する
  - エミュレータモードの場合、その旨を表示し本番認証チェックをスキップする
  - _Requirements: 6.1, 6.2_

- [x] 6.2 エミュレータ接続テスト機能を実装する
  - エミュレータモードの場合、指定されたホストへの接続テストを実行する
  - 接続できない場合、エミュレータの起動状態確認を促すガイダンスを表示する
  - 6.1 でエミュレータモードが検出された場合のみ実行
  - _Requirements: 6.3, 6.4_

- [x] 7. 診断レポート生成・表示機能を実装する

- [x] 7.1 (P) ステータスアイコン付き結果表示機能を実装する
  - 各チェック項目の結果をステータスアイコン（成功/警告/エラー）付きで整形する
  - 成功は緑色のチェックマーク、警告は黄色の三角、エラーは赤いバツで表示する
  - _Requirements: 5.1_

- [x] 7.2 (P) サマリー表示機能を実装する
  - 全チェック完了後に成功・警告・エラーの件数を集計して表示する
  - 全て成功の場合「環境は正常です」メッセージを表示する
  - 問題がある場合、問題数と重要度を明示する
  - _Requirements: 5.2, 5.3, 5.4_

- [x] 7.3 (P) JSON 出力機能を実装する
  - --json フラグが指定された場合、診断結果を JSON 形式で出力する
  - スクリプトや CI/CD パイプラインでの利用を想定した構造化出力
  - _Requirements: 5.6_

- [x] 7.4 (P) verbose ログ出力機能を実装する
  - --verbose フラグが指定された場合、各チェックの詳細な実行ログを表示する
  - チェック開始・終了タイミング、詳細な検出結果を含める
  - _Requirements: 5.7_

- [x] 8. 診断統合サービスを実装する
  - 各チェッカーを順次実行し、結果を集約する
  - エミュレータモード検出による条件分岐を処理する
  - 各チェッカーの失敗が他のチェックに影響しないよう、部分的失敗を許容する
  - 全チェック結果を DiagnosticReport として返す
  - タスク 2〜6 で実装した全チェッカーに依存
  - _Requirements: 6.1, 6.2_

- [x] 9. doctor コマンドの CLI エントリーポイントを実装する
  - oclif の BaseCommand を継承し、firex doctor コマンドを登録する
  - --json フラグと --verbose フラグを定義し、オプションとして処理する
  - 診断統合サービスを呼び出し、結果をレポーターで整形して出力する
  - エラーがある場合は終了コード 1、警告のみまたは成功の場合は終了コード 0 で終了する
  - タスク 7、8 の完了に依存
  - _Requirements: 5.5, 5.7_

- [x] 10. 統合テストと動作検証を行う

- [x] 10.1 ユニットテストを実装する
  - 各チェッカーの個別動作を検証するテストを作成する
  - バージョン文字列パース、コマンド実行モック、スキーマ検証エラー生成を含める
  - タイムスタンプ比較、npm パッケージ判定の境界ケースをテストする
  - _Requirements: 1.1, 1.2, 3.4, 4.2_

- [x] 10.2 統合テストを実装する
  - 全チェッカーを統合した診断フローをテストする
  - エミュレータモード分岐の動作を検証する
  - 実際の設定ファイルでのバリデーションフローをテストする
  - _Requirements: 6.1, 6.2_

- [x] 10.3 E2E テストを実装する
  - `firex doctor` コマンドの基本実行と出力形式を検証する
  - `--json` フラグでの JSON 出力、`--verbose` フラグでの詳細ログを確認する
  - 終了コードの正確性（エラー時 1、それ以外 0）を検証する
  - _Requirements: 5.5, 5.6, 5.7_

- [x] 11. ドキュメントを更新する
  - README.md に `firex doctor` コマンドの使用方法を追加する
  - コマンドオプション（--json, --verbose）の説明を含める
  - 診断項目の一覧と期待される出力例を記載する
  - _Requirements: N/A_

---

## 追加タスク（統合漏れ対応）

> **発見経緯**: `/kiro:validate-impl` による検証で、ConfigChecker のメソッドが DoctorService に統合されていないことが判明。
> 設計書 (design.md) の Diagnostic Flow および Requirements Traceability に記載されているが、実装が欠落していた。

- [x] 12. ConfigChecker バリデーションメソッドを DoctorService に統合する
  - 設計書で定義された ConfigChecker の追加メソッドを DoctorService.runDiagnostics() に統合する
  - 要件 3.2〜3.6 の受け入れ基準を満たすために必要
  - _Requirements: 3.2, 3.3, 3.4, 3.5, 3.6_

- [x] 12.1 validateConfigSyntax() の統合
  - checkConfigFile() が設定ファイルを検出した場合、構文検証を実行する
  - YAML/JSON の構文エラーがある場合、エラーの行番号・列番号を含む詳細を表示する
  - _Requirements: 3.2, 3.3_

- [x] 12.2 validateConfigSchema() の統合
  - 構文検証が成功した場合、zod スキーマによるバリデーションを実行する
  - スキーマ違反がある場合、違反している項目と期待される値の形式を表示する
  - _Requirements: 3.4, 3.5_

- [x] 12.3 validateCollectionPaths() の統合
  - 設定ファイルにコレクションパスが含まれる場合、パス形式の検証を実行する
  - Firestore のパス規則（奇数セグメント = コレクション）に従っているか確認する
  - _Requirements: 3.6_

- [x] 12.4 統合後のテスト追加
  - DoctorService の統合テストに構文検証・スキーマ検証・パス検証のフローを追加する
  - 各バリデーションエラーが正しく診断レポートに含まれることを確認する
  - _Requirements: 3.2, 3.3, 3.4, 3.5, 3.6_

---

## 改善タスク（診断情報の実用性向上）

> **発見経緯**: ユーザーレビューにより、現在の診断項目では実際の問題解決に必要な情報が不足していることが判明。
> 特に認証情報とプロジェクト ID の表示が不十分。

- [x] 13. 認証情報の詳細表示機能を実装する
  - 現在使用されている認証タイプ（ADC / Service Account）を明示的に表示する
  - 認証に紐づくアカウント情報（メールアドレス等）を表示する
  - Service Account の場合、ファイルパスとサービスアカウントメールを表示する

- [x] 13.1 認証タイプ検出機能を実装する
  - `GOOGLE_APPLICATION_CREDENTIALS` 環境変数の有無で Service Account を検出
  - ADC の場合、gcloud の現在のアカウント情報を取得
  - 出力例:
    ```
    [✓] 認証情報
        Type: Application Default Credentials (ADC)
        Account: user@example.com
    ```

- [x] 13.2 Service Account 情報表示機能を実装する
  - `GOOGLE_APPLICATION_CREDENTIALS` で指定されたファイルを読み取り
  - `client_email` フィールドからサービスアカウントメールを抽出
  - 出力例:
    ```
    [✓] 認証情報
        Type: Service Account
        File: ./serviceAccount.json
        Email: firebase-adminsdk@my-project.iam.gserviceaccount.com
    ```

- [x] 14. プロジェクト ID 解決情報の表示機能を実装する
  - 現在 firex が接続するプロジェクト ID を明示的に表示する
  - プロジェクト ID の解決元（.firebaserc / 環境変数 / Service Account）を表示する
  - 出力例:
    ```
    [✓] プロジェクト
        Project ID: my-project-dev
        Source: .firebaserc (default alias)
    ```

- [x] 14.1 プロジェクト ID 解決優先順位の実装
  - 解決優先順位: 環境変数 > .firebaserc > Service Account の project_id
  - どのソースから解決されたかを明示する

- [x] 15. ビルドチェックを --verbose 専用に変更する
  - 開発者にとって価値が低いため、通常実行時はスキップ
  - `--verbose` フラグ指定時のみビルド状態チェックを実行する

- [x] 16. 改善後のテスト追加
  - 認証タイプ検出（ADC / Service Account）のテストを追加
  - プロジェクト ID 解決優先順位のテストを追加
  - 各パターンでの表示形式が正しいことを検証
