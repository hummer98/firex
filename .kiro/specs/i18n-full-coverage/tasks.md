# Implementation Plan

## Task List

- [x] 1. i18nモジュールにメッセージキーと翻訳を追加する
- [x] 1.1 エラーハンドラー用のメッセージキーを定義する
  - 認証エラー（無効な認証、タイムアウト、プロジェクト未検出、権限拒否、未初期化等）用のキーを追加
  - 設定エラー（ファイル未検出、パースエラー、バリデーションエラー等）用のキーを追加
  - Firestoreエラー（NOT_FOUND、PERMISSION_DENIED、QUOTA_EXCEEDED、UNAVAILABLE、TIMEOUT等）用のキーを追加
  - バリデーションエラー（フィールド付き、汎用）用のキーを追加
  - スタックトレースラベルとヘルプ提案用のキーを追加
  - 各キーに対して日本語と英語の翻訳を定義
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 3.1, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3_

- [x] 1.2 診断サービス用のメッセージキーを定義する
  - 診断進捗メッセージ（開始、各チェック開始、完了等）用のキーを追加
  - 診断エラーメッセージ（チェック失敗、実行失敗、フォーマット失敗等）用のキーを追加
  - フラグ説明（--json）用のキーを追加
  - 各キーに対して日本語と英語の翻訳を定義
  - _Requirements: 2.1, 2.2, 2.3, 2.5, 2.6, 3.2, 3.3, 3.4, 3.5_

- [x] 1.3 (P) 診断チェッカー用のメッセージキーを定義する
  - EnvironmentChecker用キー（Node.jsバージョン、Firebase CLI、認証状態）を追加
  - FirebaseChecker用キー（プロジェクトID、エミュレータ接続、Firestore API、アクセス権）を追加
  - ConfigChecker用キー（設定ファイル検出、構文検証、スキーマ検証、パス検証）を追加
  - BuildChecker用キー（ビルド状態、ディレクトリ確認、タイムスタンプ比較）を追加
  - 各キーに対して日本語と英語の翻訳を定義
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 3.2, 3.3, 3.4, 3.5_

- [x] 2. エラーハンドラーのメッセージをi18n化する
  - 認証エラー処理でハードコードされたメッセージをt()関数呼び出しに置換
  - 設定エラー処理でハードコードされたメッセージをt()関数呼び出しに置換
  - Firestoreエラー処理でハードコードされたメッセージをt()関数呼び出しに置換
  - バリデーションエラー処理でハードコードされたメッセージをt()関数呼び出しに置換
  - スタックトレース表示とヘルプ提案メッセージをt()関数呼び出しに置換
  - 動的な値（パス、フィールド名等）は文字列連結で組み込む
  - 既存のメソッドシグネチャを変更しない
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 4.1, 4.2, 4.3, 5.1_

- [x] 3. 診断サービスとコマンドのメッセージをi18n化する
- [x] 3.1 DoctorServiceの進捗・エラーメッセージをi18n化する
  - verbose時の進捗メッセージ（診断開始、各チェック開始等）をt()関数呼び出しに置換
  - エラー結果作成時のメッセージをt()関数呼び出しに置換
  - console.log出力パターンを維持しながらメッセージ内容をローカライズ
  - _Requirements: 2.1, 2.2, 2.3, 2.6, 5.1_

- [x] 3.2 (P) DoctorCommandのフラグ説明とエラーメッセージをi18n化する
  - --jsonフラグのdescriptionをt()関数呼び出しに置換
  - エラー時のloggingService.error呼び出しメッセージをt()関数呼び出しに置換
  - _Requirements: 2.5, 2.6, 5.1_

- [x] 4. 診断チェッカーモジュールのメッセージをi18n化する
- [x] 4.1 (P) EnvironmentCheckerのメッセージをi18n化する
  - Node.jsバージョンチェックのメッセージ（インストール済み、最小バージョン、アップグレード推奨等）をt()関数呼び出しに置換
  - Firebase CLIチェックのメッセージ（インストール済み、未インストール、インストール案内等）をt()関数呼び出しに置換
  - 認証状態チェックのメッセージ（認証情報、エミュレータモード、サービスアカウント、ADC等）をt()関数呼び出しに置換
  - createCheckResult呼び出し時のmessage/details/guidanceをローカライズ
  - _Requirements: 6.1, 5.1_

- [x] 4.2 (P) FirebaseCheckerのメッセージをi18n化する
  - .firebaserc検出チェックのメッセージ（検出、未検出、パースエラー等）をt()関数呼び出しに置換
  - プロジェクトID解決のメッセージ（解決成功、ソース表示等）をt()関数呼び出しに置換
  - Firestore API有効化チェックのメッセージ（有効、未初期化、無効、確認失敗等）をt()関数呼び出しに置換
  - Firestoreアクセス権チェックのメッセージ（アクセス可能、コレクション数、権限なし等）をt()関数呼び出しに置換
  - エミュレータ接続チェックのメッセージ（接続成功、HTTPステータス、接続失敗等）をt()関数呼び出しに置換
  - _Requirements: 6.2, 5.1_

- [x] 4.3 (P) ConfigCheckerのメッセージをi18n化する
  - 設定ファイル検出のメッセージ（検出、ファイルパス、未検出、デフォルト使用等）をt()関数呼び出しに置換
  - YAML/JSON構文検証のメッセージ（有効、エラー、位置情報等）をt()関数呼び出しに置換
  - スキーマ検証のメッセージ（有効、無効、有効フィールド一覧等）をt()関数呼び出しに置換
  - コレクションパス検証のメッセージ（全て有効、無効パス、セグメントヒント等）をt()関数呼び出しに置換
  - _Requirements: 6.3, 5.1_

- [x] 4.4 (P) BuildCheckerのメッセージをi18n化する
  - npmパッケージ判定のメッセージをt()関数呼び出しに置換
  - ビルド状態チェックのメッセージ（スキップ、distディレクトリなし、リビルド必要、最新等）をt()関数呼び出しに置換
  - _Requirements: 6.4, 5.1_

- [x] 5. 後方互換性と品質を検証するテストを実装する
- [x] 5.1 i18nモジュールの品質検証テストを追加する
  - 日本語と英語で同数のメッセージキーが存在することを検証
  - 各メッセージキーの値が空文字列でないことを検証
  - setLocale後に正しい言語のメッセージが返されることを検証
  - 既存のt()関数呼び出しパターンとの互換性を検証
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 5.1, 5.2_

- [x] 5.2 (P) エラーハンドラーのローカライズテストを追加する
  - 各エラータイプでt()が正しく呼び出され、適切なメッセージが返されることを検証
  - ロケール切替後のエラーメッセージ言語切替を検証
  - 動的な値が正しく組み込まれることを検証
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 7.4_

- [x] 5.3 (P) 診断機能のローカライズテストを追加する
  - DoctorServiceのverbose進捗メッセージがローカライズされることを検証
  - 各チェッカーモジュールの診断結果メッセージがローカライズされることを検証
  - DoctorCommandのフラグ説明がローカライズされることを検証
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 6.1, 6.2, 6.3, 6.4, 7.4_

- [x] 5.4 後方互換性の統合テストを追加する
  - ロケール環境変数未設定時にデフォルトで英語が使用されることを検証
  - ロケールが日本語設定時に既存メッセージと同等の内容が表示されることを検証
  - 既存のメッセージキーと翻訳が変更なく保持されていることを検証
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x]* 5.5 (P) E2Eテストでロケール切替の動作を検証する
  - LANG=ja設定でfirex doctorを実行し日本語メッセージが出力されることを検証
  - LANG=en設定でfirex doctorを実行し英語メッセージが出力されることを検証
  - エラー発生時にロケールに応じたエラーメッセージが表示されることを検証
  - _Requirements: 7.4, 5.3, 5.4_

## Remediation Tasks (Inspection-2)

以下のタスクはinspection-2で特定されたCritical Issue修正用です。

- [x] 6. CheckResultにメタデータフィールドを追加する
- [x] 6.1 types.tsのCheckResult型を拡張する
  - CheckResultにmetadata?: Record<string, unknown>フィールドを追加
  - createCheckResult関数にmetadataパラメータを追加（オプショナル）
  - 既存のcreateCheckResult呼び出しは変更不要（後方互換性維持）
  - _Requirements: 5.1, 5.2 (後方互換性)_

- [x] 6.2 ConfigCheckerのcheckConfigFileでmetadataを返す
  - 設定ファイル検出成功時に{ filePath: string, found: true }をmetadataとして返す
  - 設定ファイル未検出時に{ found: false }をmetadataとして返す
  - 表示用メッセージ（message, details）は変更なし
  - _Requirements: 6.3, Design Amendment_

- [x] 6.3 DoctorServiceをメタデータベースのロジックに修正する
  - configResult.value.message.includes('設定ファイルが見つかりました')を削除
  - configResult.value.details?.match(/ファイルパス: (.+)$/)を削除
  - configResult.value.metadata?.foundとmetadata?.filePathを使用
  - 英語ロケールでも設定ファイル構文・スキーマ検証が実行されることを確認
  - _Requirements: 2.1, 2.2, 2.3, 5.4, Design Amendment_

- [x] 6.4 テストをメタデータベースに更新する
  - doctor-service.test.tsのモックをmetadata付きに更新
  - 日本語メッセージ文字列のハードコードを削除
  - 英語ロケールでのテストケースを追加
  - _Requirements: 7.4, Design Amendment_

- [x] 6.5 ロケール切替の動作確認を行う
  - LANG=en firex doctorで設定ファイル検証が実行されることを確認
  - LANG=ja firex doctorで設定ファイル検証が実行されることを確認
  - 両ロケールで同等の機能が提供されることを検証
  - _Requirements: 5.3, 5.4, 7.4_
